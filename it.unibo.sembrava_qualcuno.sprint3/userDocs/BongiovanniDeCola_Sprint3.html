<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
		<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
		<script type="text/javascript" src="../css/issStyle.js"></script>
	-->
	<style type="text/css">
		body {
			margin-left:  30px;
			margin-right: 30px;
		}

		P {
			font-family: Tahoma;
			font-size: 10pt;
		}

		a, a:visited, a:active, a:link, a:hover {
			text-decoration: underline;
			color: #545454;
			background-color: transparent;
			font-size: 93%;
		}

		a:hover {
			background-color: #cccccc;
		}

		hr {
			clear: both;
			height: 1px;
			color: #242424;
			background-color: transparent;
		}

		h1, h2, h3 {
			color: #242424;
			clear: left;
			font: 100% Tahoma, Helvetica, Arial, sans-serif;
			margin-bottom: 0.5em;
			padding-top: 0.5em;
			border-radius: 10px;
			padding: 5px;
		}

		top {
			width: 100%;
		}

		#i {
			color: #ff1010;
		}

		tt {
			font-family: "Arial";
			font-size: 90%;
			color: #006600;
		}

		em {
			font-family: "Arial";
			font-size: 80%;
			font-weight: bold;
			border-style:solid;
			border-color: #abe876;
			color: #1632cc;
		}

		bc {
			font-family: "Arial";
			font-size: 90%;
			font-weight: bold;
			color: #990000;
			background-color: #fcf8c7;
		}

		ks {
			font-family: "Arial";
			font-weight: bold;
			color: #0000CD	;
			font-size: 90%;
		}

		kc {
			font-family: "Arial";
			font-weight: bold;
			color: #008000	;
			font-size: 90%;
		}

		pre {
			font-family: "Consolas";
			font-size: 85%;
			background-color: #f5f5f5;
			border: 1.5px solid silver;
			padding: 5px;
		}

		m {
			font-family: "Helvetica";
			line-height: 100%;
			font-size: 75%;
		}

		div.body {
			font-size: 18px;
		}

		k, lr {
			color: #990000;
			font-weight: bold;
			font-size: 90%;
		}

		h1 {
			font-size: 150%;
			background-color: #b2c0ff;
			padding: 10px;
		}

		h2 {
			background-color: #9ed8ff;
			font-size: 130%;
		}

		h3 {
			background-color: #e6ccff;
			font-size: 100%;
		}

		h4 {
			background-color: #ccffcc;
			font-size: 100%;
			width: 95%;
			border-radius: 5px;
			padding: 2px;
		}

		h5 {
			background-color: #d5ffb0;
			font-size: 100%;
		}

		div.req {
			background-color: #d9ffb3;
			font-size: 18px;
			width: 700px;
			border: 3px solid green;
			padding: 15px;
			margin: 10px;
		}

		div.remark {
			background-color: #E3F2FD;
			border: 1.5px solid #d5f2ed;
			padding: 15px;
			margin: 10px;
			border-radius: 25px;
		}

		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
		}

		ol, ul, li {
			margin: 0;
			margin-left: 10px;
			padding: 0;
			padding-bottom: 5px;
		}

		table, th, td {
			border: 1px solid black;
		}

		img {
			border: 1.5px solid #d5f2ed
		}

		a, a:visited, a:active, a:link, a:hover {
			text-decoration: underline;
			color: #545454;
			background-color: transparent;
		}

		div.wrapdesc {
			width: 90%;
			margin: auto;
		}

		div.imagedesc {
			width: 85%;
			margin: auto;
		}

		.fr li::marker {
			content: "F" counter(list-item) " ";
			color: mediumslateblue;
		}

		.nfr li::marker {
			content: "NF" counter(list-item) " ";
			color: mediumslateblue;
		}

		.sprint td {
			width: 33%;
		}
	</style>
		
	<head>
		<title>Final Task 2021 Sprint 3</title>
		<script type="text/javascript">
			function onLoad() {
				//setRequirementsId();
				addLrLinks();
				addAutoLinks();
			}

			function setRequirementsId() {
				var fRequirements = document.getElementsByClassName("fr")[0].children;
				var nfRequirements = document.getElementsByClassName("nfr")[0].children;
				var i;
				for(i = 0; i < fRequirements.length; i++)
					fRequirements[i].id = "F" + (i + 1);
				for(i = 0; i < nfRequirements.length; i++)
					nfRequirements[i].id = "NF" + (i + 1);
			}

			function addLrLinks() {
				var lrList = document.getElementsByTagName("lr");

				for(var i = 0; i < lrList.length; i++) {
					org_html = lrList[i].outerHTML;
					new_html = "<a href=../../it.unibo.sembrava_qualcuno.tf21Start/userDocs/BongiovanniDeCola_tf21Start.html#" + lrList[i].textContent + ">" + org_html + "</a>";
					lrList[i].outerHTML = new_html;		
			lrList[i].outerHTML = new_html;		
					lrList[i].outerHTML = new_html;		
				}
			}

			function addAutoLinks() {
				var elements = document.getElementsByClassName("al");

				for(var i = 0; i < elements.length; i++) {
					org_html = elements[i].outerHTML;
					new_html = "<a href=#" + elements[i].textContent + ">" + org_html + "</a>";
					elements[i].outerHTML = new_html;	
			elements[i].outerHTML = new_html;	
					elements[i].outerHTML = new_html;	
				}
			}
		</script>
	</head>
		
	<body onload="onLoad();">
		<div id="top">
			<h1>ISS | Final Task Sprint 3 <font size="5"></font></h1>
		</div>   

		<div class="body"> 
			<h2 id="sprint3">Introduction</h2>
				<div class="remark">
					Our motto:<br/>   
					<k>there is no code without a project, no project without problem analysis and no problem without requirements</k>.
				</div>
				Hereafter we updated the sprint backlog with the undone tasks from sprint1 and sprint2 and old tasks have been switched to "must have" as we want to deliver a full deployable service for client use cases<br>
				<table class="sprint">
					<thead>
						<tr>
							<th>Must Have</th>
							<th>Should Have</th>
							<th>Could Have</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>
								The client must successfully submit a parking request (<lr>F1</lr>)<br>
								The service must accept a request if the INDOOR area is free (<lr>F2</lr>) <br>
								The robot must accept a client request if it is available (<lr>F2</lr>-<lr>NF5</lr>)<br>
								The token is supposed to be unique and unforgeable (<lr>NF1</lr>)<br>
								The SpringViewIndoor is supposed to show a prompt for the client to interact with to notify to the system that the car has been placed in the INDOOR area (<lr>F4</lr>)<br>
								The SpringViewIndoor is supposed to show a prompt for the client to interact with for his parking request (<lr>F1</lr>)<br>
								The SpringViewOutdoor is supposed to show a prompt to the client for him to submit the token (<lr>F7</lr>)
							</td>
							<td></td>
							<td></td>
						</tr>
					</tbody>
				</table>
				This sprint could leverage and reuse some components created in the previous sprint so <k>two days</k> should be enough.
			<div class="remark">
				<center><em>In the following diagrams, the Green color is associated with "Controller" or "Buisness logic" components, the Blue color to "Model" components and the Red color to "Interface" components (e.g. GUIs, Communication interfaces, etc.)</em></center><br> 
			</div>
			<h2>Project</h2>
				Starting from the <a href="../../it.unibo.sembrava_qualcuno.tf21Start/userDocs/BongiovanniDeCola_tf21Start.html#archLogica">logic architecture</a> derived during the analysis phase and considering the results of <a href="../../it.unibo.sembrava_qualcuno.sprint2/userDocs/BongiovanniDeCola_Sprint2.html#Final outline">Sprint2</a> let's now update 
				the components we require for this sprint: SpringController/View, ClientService. Furthermore, we want to specify that all what we developed in Sprint2 stand also for this sprint and only changes and updates to it are hereby presented. 
				
				<h3>SpringIndoorView</h3>
					<table>
						<tr><td>
							<h4>Client home page</h4>
							<center><img src="./img/ClientInHomePage.png" width="70%"></center>
						</td><td>
							<h4>Client home page error: no parking slot available</h4>
							<center><img src="./img/ClientInHomeNoParking.png" width="70%"></center>
						</td></tr>
						<tr><td>
							<h4>Client home page error: trolley stopped</h4>
							<center><img src="./img/ClientInHomeTrolleyStopped.png" width="70%"></center>
						</td><td>
							<h4>Client home page error: indoor area engaged</h4>
							<center><img src="./img/ClientHomeIndoorEngaged.png" width="70%"></center>
						</td></tr>
						<tr><td>
							<h4>Good reqenter: SLOTNUM notification and carenter view</h4>
							<center><img src="./img/ClientCarenter.png" width="70%"></center>
						</td><td>
							<h4>Client carenter error: car not parked on indoor</h4>
							<center><img src="./img/ClientCarenterIndoorFree.png" width="70%"></center>
						</td></tr>
					</table>
					<center><table>
						<tr><td>
								<h4>Client receipt</h4>
							<center><img src="./img/ClientReceipt.png" width="70%"></center>
						</td></tr>
					</table></center>

				<h3>SpringOutdoorView</h3>
					<table>
						<tr><td>
							<h4>Client home page</h4>
							<center><img src="./img/ClientOutHomePage.png" width="70%"></center>
						</td><td>
							<h4>Client home page error: trolley stopped</h4>
							<center><img src="./img/ClientOutHomeTrolleyStopped.png" width="70%"></center>
						</td></tr>
						<tr><td>
							<h4>Client home page error: outdoor area engaged</h4>
							<center><img src="./img/ClientHomeOutdoorEngaged.png" width="70%"></center>
						</td><td>
							<h4>Client home page error: invalid tokenid</h4>
							<center><img src="./img/ClientHomeInvalidToken.png" width="70%"></center>
						</td></tr>
					</table>
					<center><table>
						<tr><td>
							<h4>Client correct tokenid</h4>
							<center><img src="./img/ClientReqexit.png" width="70%"></center>
						</td></tr>
					</table></center>

				<h3>SpringController</h3>
					<table style="width:98%">
						<tbody>
						<tr><td style="width:60%">
							<h4>Using RESTful APIs for the M2M interaction (cont.d) and JS for H2M interaction</h4>
							As already known, the M2M interaction has been developed using RESTful APIs (<a href=" ../../it.unibo.sembrava_qualcuno.sprint1/userDocs/REST-APIdocs.html">API docs</a>).
							These are managed by the already known <a href="../parkmanagerservice/src/main/kotlin/controller/SpringController.kt">SpringController</a>; the H2M interaction, however, is orchestrated by
							a client-side <a href="../parkmanagerservice/src/main/resources/static/app.js">app.js</a> file and a <a href="../parkmanagerservice/src/main/kotlin/controller/BaseController.kt">BaseController</a>: the BaseController
							accepts <tt>/client</tt> or <tt>/clientOut</tt> request to return to the home pages while the app.js changes the DOM elements of the page according to the responses of the SpringController (e.g. changes
							buttons to let the client perform different actions).<br>
							To implement some sort of "session timeout" (1 min), we exploited JS ability to fire up alarms when a certain time is reached: this alarms will trigger the return to the homepage as a countermeasure for the client leaving or <k>DoS attacks</k> to the service:
<pre>
var timeout
var timeoutValue = 60
var seconds
...
function reqenter() {
	seconds = timeoutValue
	...
	 timeout = setInterval(function() {
            seconds--
            document.getElementById("countdown").innerHTML = seconds + "s ";
            if (seconds == 0) {
              clearInterval(x);
              window.location = '/client'
            }
          }, 1000);
        }
</pre>
							<br>We exploited the Spring Framework once again to simplify our code by using the <tt>@Controller</tt> and <tt>@RestController</tt> to diversify these two controllers:
							<ul>
								<li>The  <tt>@RestController</tt> annotation was used for the SpringController as it is a combination of the  <tt>@Controller</tt> and <tt>@ResponseBody</tt> annotations:
								the @Controller annotation specializes the annotated component to be a MVC controller, while the @ResponseBody one lets you include objects in the HTTPResponse an automatically encodes them
								in json format, which is what we needed to implement our REST-APIs</li>
								<li>The <tt>@Controller</tt> annotation has been used for the BaseController as we didn't need to send objects in its responses, rather html pages, so the @ResponseBody annotation was not required.</li>
							</ul>
							We also annotated the controllers' methods with <tt>@GetMapping</tt>, to automatically fire specific methods for specific requests. An example is provided by the code below:
						</td>
							<td>
								<center><img src="./img/APISequenceDiagram.png" width="95%"></center>
							</td></tr>
						</tbody>
					</table>
<pre>
@Controller
class BaseController {
	...
	@GetMapping("/client")
    fun clientInHomepage(): String {
        return "clientInHomepage"
    }
	...
}

@RestController
class SpringController {
	...
	@GetMapping("/client/reqenter")
	fun reqenter(): ResponseEntity&lt;ParkingSlot&gt; {
        var request = MsgUtil.buildRequest("springcontroller", "reqenter", "reqenter(X)", "clientservice")
        val reply = ApplMessageUtil.messageFromString(connParkClientService.request(request))

        val message: Message = Json.decodeFromString(reply.msgContent)

        //Error
        if (message.code != 0)
            throw ApiErrorException(HttpStatus.FORBIDDEN, ApiError(message.code, message.message))

        return ResponseEntity.ok(ParkingSlot(message.message.toInt()))
    }
	...
}
</pre>
				<h3>ClientService</h3>
					<table style="width:98%">
						<tbody>
						<tr><td style="width:60%">
							<h4>The ClientService as a Moore's Finite State Machine (cont.d)</h4>
								The ClientService has been completed by adding the last checks to perform before accepting a <k>reqenter</k> request: 
								<ul>
									<li>The indoor area must be free: check if the WeightSensor detects that a car is present</li>
									<li>The trolley must be either in <tt>idle</tt> or <tt>working</tt> state: inspect the trolley CoAP resource to know about its state</li>
								</ul>
								Moreover, if the client takes too much time to park his car to the INDOOR area and/or notify this to the service, a timeout will bring back the service to
							    the <tt>work</tt> state, to reset the ClientService behaviour. This situation could occur either if the client has left without
								notifying this or someone want to perform a <k>DoS attack</k>: in this way we prevent the ClientService of stalling in the <tt>handleEnterRequest</tt>/<tt>enterthecar</tt> states.<br>
								To grant user-friendliness, we also thought that if a <tt>carenter</tt> request arrives at the end of a <tt>enterthecar</tt> state, it will trigger the <tt>enterthecar</tt>
								state once again as it could be that a client hasn't parked the car well on the indoor area and we want to give him another chance without repeating the whole process from the start.<br>
								Still to boost user-friendliness we decided to change the <tt>TOKENID</tt> format, without changing the information it retains:
<pre>
 &lt;SLOTNUM&gt;ddMMyyyyhhmmss
</pre>
						</td>
						<td>  
							<center><img src="./img/ClientServiceFSM.png" width="100%"></center>
						</td></tr>

					</table>
			<h2>Deployment</h2>
				To end this sprint we thought to deploy what has been completed, as all the client buisness logic has been developed. We decided to divide our system in 5 nodes:
				<ul>
					<li>The <em>indoorarea</em> node: holds the WeightSensorMock and Interface and its configuration files</li>
					<li>The </em>outdoorarea</em> node: holds the SonarMock and Interface and its configuration files</li>
					<li>The </em>parkmanagerservice</em> node: holds two artifacts:
						<ul>
							<li><em>parkmanagerservice-1.0.tar</em>: contains the ClientService, Trolley, WeightSensor/Sonar Interface and SonarController and its configuration files. Also contains the prolog knowledge base for the qak infrastructure</li>
							<li><em>parkmanagerservice-boot-1.0.tar</em>: contains the SpringBoot components: BaseController, SpringController and the SpringModel (e.g. ParkingSlot.kt, ApiError.kt, etc...)</li>
						</ul>
						Depends on the indoorarea, outdoorarea and basicrobot.
					</li>
					<li>The </em>basicrobot</em> node: holds the BasicRobot; depends on wenv</li>
					<li>The </em>wenv</em> node: holds the WEnv and the virtual robot</li>
				</ul>
				See the image below for a deployment diagram:<br>
				<center><img id="Deployment" src="./img/Sprint3Deployment.png" width="70%"></center>
				
				We also decided to proceed with the deployment using the Docker container technology.
				<h3>indoorarea Dockerfile</h3>
					We provide a <a href="../indoorarea/Dockerfile">Dockerfile</a> to build and run a Docker image for the indoor area.<br>
					
<pre><tt># To build (in the indoorarea/ folder):</tt>
docker build --rm -t indoorarea .
<tt># To run:</tt>
docker run -rm -i -p8025:8025 indoorarea 
</pre>			
				<h3>outdoorarea docker image creation</h3>
					We provide a <a href="../outdoorarea/Dockerfile">Dockerfile</a> to build and run a Docker image for the outdoor area.<br>
					
<pre><tt># To build (in the outdoorarea/ folder):</tt>
docker build --rm -t outdoorarea .
<tt># To run:</tt>
docker run -rm -i -p8026:8026 outdoorarea 
</pre>
				<h3>parkmanagerservice image creation</h3>
					We provide a <a href="../parkmanagerservice/Dockerfile">Dockerfile</a> to build and run a Docker image for the parkmanagerservice.<br>
<pre><tt># To build (in the parkmanagerservice/ folder):</tt>
docker build --rm -t parkmanagerservice .
<tt># To run:</tt>
docker run -rm -i -p8080:8080 parkmanagerservice 
</pre>
				<h3>Deployment using Docker</h3>
					We also provide a <a href="../automatedcarparking.yaml">script</a> to automatically deploy the system using one container per node, as described above.<br>
					Use it invoking 
<pre>docker-compose -f automatedcarparking.yaml</pre>
			<h2>Sprint Summary</h2>
			
			The coming figure represents the final outline resulting from the Sprint3. The dashed lines that group components together gives a glance of the physical deployment organization<br> 			<div>
				<td style="width:50%">
					<center><img id="Final outline" src="./img/FullSprint3Outline.png" width="70%"></center>
				</td>
			</div>
			<hr>
			<div class="remark">
						<center><k>This sprint is considered done and, with this sprint we consider the "client" side of this project done and deployable. The next sprint will focus on the manager side, to end the project</center><br>
			</div>
			
			<h3>Summary table</h3>
				<table class="sprint" id="summary">
						<thead>
							<tr>
								<th>Final Sprint Architecture</th>
								<th>Executable Model</th>
								<th>Tests</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>
									<center><a href="./img/FullSprint3Outline.png">FullSprint3Outline.png</a></center>
									<center><a href="./img/Sprint3Deployment.png">Sprint3Deployment.png</a></center>
								</td>
								<td>
									<center><a target="code" href="../src/parkmanagerservice/parkingArea.qak">parkingArea.qak</a></center>
									<center><a target="code" href="../automatedcarparking.yaml">automatedcarparking.yaml</a></center>
								</td>
								<td>
								<center>
									<a target="code" href="../parkmanagerservice/src/test/kotlin/parkmanagerservice/Sprint3ParkingAreaTests.kt">Sprint3ParkingAreaTests.kt</a><br>
									<a target="code" href="../parkmanagerservice/src/test/kotlin/parkmanagerservice/Sprint3TrolleyTests.kt">Sprint3TrolleyTests.kt</a><br>
								</center>
								</td>
							</tr>
						</tbody>
					</table>
				<hr>
		</div>
		<div class="footer">
			<center>			
				<table style="background-color:rgba(30, 22, 255, 0.9); width:60%;text-align:center;color:white">	
					<tr>
						<td colspan="2">By</td>
					</tr>
					<tr>
						<td style="width:50%">
							<img src="./img/bongiovanni_luca.jpg" style="width:50%"> <br/>
							Luca Bongiovanni <br/>
							email: luca.bongiovanni@studio.unibo.it
						</td>
						<td style="width:50%">
							<img src="./img/fototessera gmdc.jpg"  style="width:50%"><br/>
							Gian Marco De Cola <br/>		 
							email: gianmarco.decola@studio.unibo.it			 
						</td>
					</tr>
					<tr>
						<td colspan="2">
							<b>PROJECT REPO</b>: <a style="color: white;" href="https://github.com/sembrava-qualcuno/issLab21/tree/master/it.sembrava_qualcuno.unibo.tf21Start">
							https://github.com/sembrava-qualcuno/issLab21/tree/master/it.sembrava_qualcuno.unibo.tf21Start</a>
						</td>
					</tr>
				</table>
			</center>
		</div>
	</body>
</html>
