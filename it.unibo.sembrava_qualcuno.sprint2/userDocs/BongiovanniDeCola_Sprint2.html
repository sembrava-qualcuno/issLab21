<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
		<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
		<script type="text/javascript" src="../css/issStyle.js"></script>
	-->
	<style type="text/css">
		body {
			margin-left:  30px;
			margin-right: 30px;
		}

		P {
			font-family: Tahoma;
			font-size: 10pt;
		}

		a, a:visited, a:active, a:link, a:hover {
			text-decoration: underline;
			color: #545454;
			background-color: transparent;
			font-size: 93%;
		}

		a:hover {
			background-color: #cccccc;
		}

		hr {
			clear: both;
			height: 1px;
			color: #242424;
			background-color: transparent;
		}

		h1, h2, h3 {
			color: #242424;
			clear: left;
			font: 100% Tahoma, Helvetica, Arial, sans-serif;
			margin-bottom: 0.5em;
			padding-top: 0.5em;
			border-radius: 10px;
			padding: 5px;
		}

		top {
			width: 100%;
		}

		#i {
			color: #ff1010;
		}

		tt {
			font-family: "Arial";
			font-size: 90%;
			color: #006600;
		}

		em {
			font-family: "Arial";
			font-size: 80%;
			font-weight: bold;
			border-style:solid;
			border-color: #abe876;
			color: #1632cc;
		}

		bc {
			font-family: "Arial";
			font-size: 90%;
			font-weight: bold;
			color: #990000;
			background-color: #fcf8c7;
		}

		ks {
			font-family: "Arial";
			font-weight: bold;
			color: #0000CD	;
			font-size: 90%;
		}

		kc {
			font-family: "Arial";
			font-weight: bold;
			color: #008000	;
			font-size: 90%;
		}

		pre {
			font-family: "Consolas";
			font-size: 85%;
			background-color: #f5f5f5;
			border: 1.5px solid silver;
			padding: 5px;
		}

		m {
			font-family: "Helvetica";
			line-height: 100%;
			font-size: 75%;
		}

		div.body {
			font-size: 18px;
		}

		k, lr {
			color: #990000;
			font-weight: bold;
			font-size: 90%;
		}

		h1 {
			font-size: 150%;
			background-color: #b2c0ff;
			padding: 10px;
		}

		h2 {
			background-color: #9ed8ff;
			font-size: 130%;
		}

		h3 {
			background-color: #e6ccff;
			font-size: 100%;
		}

		h4 {
			background-color: #ccffcc;
			font-size: 100%;
			width: 95%;
			border-radius: 5px;
			padding: 2px;
		}

		h5 {
			background-color: #d5ffb0;
			font-size: 100%;
		}

		div.req {
			background-color: #d9ffb3;
			font-size: 18px;
			width: 700px;
			border: 3px solid green;
			padding: 15px;
			margin: 10px;
		}

		div.remark {
			background-color: #E3F2FD;
			border: 1.5px solid #d5f2ed;
			padding: 15px;
			margin: 10px;
			border-radius: 25px;
		}

		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
		}

		ol, ul, li {
			margin: 0;
			margin-left: 10px;
			padding: 0;
			padding-bottom: 5px;
		}

		table, th, td {
			border: 1px solid black;
		}

		img {
			border: 1.5px solid #d5f2ed
		}

		a, a:visited, a:active, a:link, a:hover {
			text-decoration: underline;
			color: #545454;
			background-color: transparent;
		}

		div.wrapdesc {
			width: 90%;
			margin: auto;
		}

		div.imagedesc {
			width: 85%;
			margin: auto;
		}

		.fr li::marker {
			content: "F" counter(list-item) " ";
			color: mediumslateblue;
		}

		.nfr li::marker {
			content: "NF" counter(list-item) " ";
			color: mediumslateblue;
		}

		.sprint td {
			width: 33%;
		}
	</style>
		
	<head>
		<title>Final Task 2021 Sprint 2</title>
		<script type="text/javascript">
			function onLoad() {
				setRequirementsId();
				addLrLinks();
				addAutoLinks();
			}

			function setRequirementsId() {
				var fRequirements = document.getElementsByClassName("fr")[0].children;
				var nfRequirements = document.getElementsByClassName("nfr")[0].children;
				var i;
				for(i = 0; i < fRequirements.length; i++)
					fRequirements[i].id = "F" + (i + 1);
				for(i = 0; i < nfRequirements.length; i++)
					nfRequirements[i].id = "NF" + (i + 1);
			}

			function addLrLinks() {
				var lrList = document.getElementsByTagName("lr");

				for(var i = 0; i < lrList.length; i++) {
					org_html = lrList[i].outerHTML;
					new_html = "<a href=#" + lrList[i].textContent + ">" + org_html + "</a>";
					lrList[i].outerHTML = new_html;		
			lrList[i].outerHTML = new_html;		
					lrList[i].outerHTML = new_html;		
				}
			}

			function addAutoLinks() {
				var elements = document.getElementsByClassName("al");

				for(var i = 0; i < elements.length; i++) {
					org_html = elements[i].outerHTML;
					new_html = "<a href=#" + elements[i].textContent + ">" + org_html + "</a>";
					elements[i].outerHTML = new_html;	
			elements[i].outerHTML = new_html;	
					elements[i].outerHTML = new_html;	
				}
			}
		</script>
	</head>
		
	<body onload="onLoad();">
		<div id="top">
			<h1>ISS | Final Task Sprint 2 <font size="5"></font></h1>
		</div>   

		<div class="body"> 
			<h2 id="sprint2">Introduction</h2>
				<div class="remark">
					Our motto:<br/>   
					<k>there is no code without a project, no project without problem analysis and no problem without requirements</k>.
				</div>
			Hereafter we report a copy of the sprint backlog for this specific sprint:<br>
			<table class="sprint">
						<thead>
							<tr>
								<th>Must Have</th>
								<th>Should Have</th>
								<th>Could Have</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>
									The robot must accept a client request if it is available (<lr>F2</lr>-<lr>NF5</lr>)<br>
									The client must successfully submit a TOKENID to begin the car collect phase (<lr>F7</lr>)<br>
									The system must correctly infer the parking slot from the provided token (<lr>F8</lr>)<br>
									The system must successfully instruct the trolley to reach the correct parking slot, collect the car and bring it to the OUTDOOR area (<lr>F9</lr>)
								</td>
								<td>
									The map should be updated with the movements of the robot (<lr>NF2</lr>) <br>
									The robot should not walk over the parking slots (<lr>NF3</lr>) <br>
									The robot should correctly return to the home position if idle (<lr>NF7</lr>)
								</td>
								<td>
									The system is not supposed to instruct the robot to move the car from the parking slot to the OUTDOOR area if it is already occupied by a car (<lr>F6</lr>)<br>
									The ParkingServiceGUI is supposed to show a prompt to the client for him to submit the token (<lr>F7</lr>)
								</td>
							</tr>
						</tbody>
					</table>
					This sprint could leverage and reuse some components created in the previous sprint so <k>four days</k> should be enough.
			<div class="remark">
				<center><em>In the following diagrams, the Green color is associated with "Controller" or "Business logic" components, the Blue color to "Model" components and the Red color to "Interface" components (e.g. GUIs, Communication interfaces, etc.)</em></center><br> 
			</div>
			<h2>Project</h2>
				Starting from the <a href="../../it.unibo.sembrava_qualcuno.tf21Start/userDocs/BongiovanniDeCola_tf21Start.html#archLogica">logic architecture</a> derived during the analysis phase and considering the results of <a href="../../it.unibo.sembrava_qualcuno.sprint1/userDocs/BongiovanniDeCola_Sprint1.html#Final outline">Sprint1</a> let's now "zoom-in" or update 
				the components we require for this sprint: SpringController/View, ClientService, Trolley and SonarController and simulator. Furthermore, we want to specify that all what we developed in Sprint1 stand also for this sprint and only changes and updates to it are hereby presented. 
				
				<h3>SpringController/View</h3>
					<table style="width:98%">
						<tbody>
						<tr><td style="width:60%">
							<h4>Using RESTful APIs for the M2M interaction (cont.d)</h4>
								The REST-API documentation has been updated and can always be found at <a href="../../it.unibo.sembrava_qualcuno.sprint1/userDocs/swagger-ui/REST-APIdocs.html">REST-APIdocs.html</a>.
							<h4>SpringController</h4>
								The SpringController is updated from the one introduced in Sprint1, by adding the method to deal with the <k>/client/reqexit</k> REST-API. Its code is available <a target="code" href="../src/it/unibo/sembrava_qualcuno/sprint2/SpringController.kt">here</a>.
						</td>
						<td>
							<center><img src="./img/APISequenceDiagram.png" width="75%"></center>
						</td></tr>
					</table>

				<h3>ClientService</h3>
					<table style="width:98%">
						<tbody>
						<tr><td style="width:60%">
							<h4>The ClientService as a Moore's Finite State Machine (cont.d)</h4>
								The ClientService actor is here updated with the code to implement the handleOutRequest state as described in the attached image. To reuse the same high-level message type to instruct the trolley to go to the INDOOR and OUTDOOR area,
								the moveToIndoor dispatch used during the Sprint1, is replaced by a moveToInOutdoor dispatch. The trolley will distinguish between the two cases using the payload of the message. <br>
								The barred actions are not part of this sprint and will be developed in Sprint3.
						</td>
						<td>  
							<center><img src="./img/ClientServiceFSM.png" width="100%"></center>
						</td></tr>
					</table>

				<h3>Trolley</h3>
					<table style="width:98%">
						<tbody>
						<tr><td style="width:60%">
							<h4>A stoppable trolley</h4>
								In this sprint, the problem of a stoppable trolley arises: even though we didn't already implement the manager sending the stop request (this will be done in Sprint4), <k>F2</k> tells us to accept a client request only if the trolley isn't in stopped state.<br>
								As stated in the analysis phase, the trolley can be stopped only when it ends a task (e.g. goes to home, to the indoor/outdoor, or to a parking slot) and not when it is on trips. Moreover, it should be able to remember in what state to return, in case a <em>resume</em> dispatch arrives.
								We decided to implement this feature by maintaining an internal state, in the form of a <em>currState</em> variable: it will be updated by the trolley every time it begins a trip, and its value will represent the end goal of a single trip. The possible values and their explaination are 
								described in the attached table.
								
						</td>
						<td>
							<center><img src="./img/CurrStateMeaning.png" width="100%"></center>
						</td></tr>
						<tr><td style="width:60%">
							<h4>The trolley as a FSM</h4>
								Of course, having implemented the trolley actor as a qakactor, its behaviour is modeled after a Moore's Finite State Machine. This sprint, however, made a few changes from the FSM resulted from the <a href="../../it.unibo.sembrava_qualcuno.tf21Start/userDocs/BongiovanniDeCola_tf21Start.html#trolleyFSM">analysis phase</a>:
								<ul>
									<li>Conditional guards where included to the state switch after a resume dispatch arrives, to match about what previously said about the currState variable</li>
									<li>The actual high-level message names where introduced as conditions for state transitions</li>
									<li>Every implication of the manager where removed as they will be introduced in Sprint4</li>
								</ul>
								Every trip is planned by the PlannerUtil class on the RoomMap space as explained during <a href="../../it.unibo.sembrava_qualcuno.sprint1/userDocs/BongiovanniDeCola_Sprint1.html#planner">Sprint1</a>
								
						</td>
						<td>
							<center><img src="./img/TrolleyFSM.png" width="95%"></center>
						</td></tr>
					</table>
				<h3>SonarController</h3>
					<table style="width:98%">
						<tbody>
						<tr><td style="width:60%">
							<h4>The need of a Sensor Interface (cont.d)</h4>
								As for the weight sensor in the first sprint we have added a <a target="code" href="../src/it/unibo/sembrava_qualcuno/sonar/SonarInterface.kt">SonarInterface</a> to abstract the concept of Sonar from the technology that it uses to communicate. As sonars are usually constrained devices, we decided to use the CoAP protocol once again for 
								<a target="code" href="../src/it/unibo/sembrava_qualcuno/sonar/CoapSonar.kt">our implementation</a> of the interface, as for the <a href="../../it.unibo.sembrava_qualcuno.sprint1/userDocs/BongiovanniDeCola_Sprint1.html#weight">CoapWeightSensor</a> in Sprint1.
							<h4>The SonarController and SonarMock</h4>
								The <a target="code" href="../src/it/unibo/sembrava_qualcuno/sonar/SonarController.kt">SonarController</a> is the entity that will be queried by the ClientService to understand if the outdoor area is free before continuing with a reqexit request from the client. This is done quering a CoAP Resource, in the form of our <a target="code" href="../src/it/unibo/sembrava_qualcuno/sonar/SonarMock.kt">SonarMock</a>.<br>
								The SonarController, however, should be completed in Sprint4, as it should also be responsible of firing an alarm when a car occupied the outdoor area for more than DTFREE seconds. For this reason, in this sprint it is not yet implemented as an object with internal thread as per the <a href="../../it.unibo.sembrava_qualcuno.tf21Start/userDocs/BongiovanniDeCola_tf21Start.html#archLogica">logic architecture</a>, but rather as a simple object.
						</td>
						<td>
							<center><img src="./img/Sonar.png" width="100%"></center>
						</td></tr>
					</table>
				
			<h2 id="tests">Testing</h2>
			To exploit the qak CoAP observable resources for testing purposes, as already done during the <a href="../../it.unibo.sembrava_qualcuno.tf21Start/userDocs/BongiovanniDeCola_tf21Start.html#tests">first test plans</a> of the analysis phase<br> and the <a href="../../it.unibo.sembrava_qualcuno.sprint1/userDocs/BongiovanniDeCola_Sprint1.html#tests">tests of the sprint1</a>, the <a href="../test/it/unibo/sembrava_qualcuno/sprint2/test/CoapObserverForTesting.kt">CoapObserverForTesting.kt</a> has been reintroduced in this sprint tests.
			For all the tests we assumed these starting conditions:
				<ul>
					<li>The trolley is not stopped by the manager</li>
					<li>The INDOOR is not relevant for this sprint</li>
					<li>The OUTDOOR is not engaged</li>
					<li>All the parking slots are free</li>
				</ul>
				These conditions were individually changed by the single tests if they needed some other context, as described below.<br>
				We decided to implement the tests relative to this sprint under three test classes: one that holds tests concerning the SonarController and mock, the ClientService and the SpringController (<a href="../test/it/unibo/sembrava_qualcuno/sprint2/test/Sprint2ParkingAreaTests.kt">Sprint1ParkingAreaTests.kt</a>),
				one that holds tests concerning the Trolley, BasicRobot, ClientService and the SpringController (<a href="../test/it/unibo/sembrava_qualcuno/sprint2/test/Sprint2TrolleyTests.kt">Sprint1TrolleyTests.kt</a>) and one for the SonarController/Mock unit tests (<a href="../test/it/unibo/sembrava_qualcuno/sprint2/test/SonarTests.kt">SonarTests.kt</a>).
				<br>Hereafter is a description of the functional tests for this <a href="#sprint2"> sprint requirements</a>:
			<ul>
				<li>Test that, if there is at least one parked car, the trolley is not stopped and the OUTDOOR area is not engaged (<k>F6</k>), a reqexit client request is accepted by the ClientService, as per <k>F2</k>-<k>NF5</k>. If not, the SpringController should return a <tt>403 forbidden http error code</tt></li>
				<li>Test that if a reqexit is accepted, it succeeds only if the TOKENID is valid and correctly corresponds to the parking slot, as per <k>F7</k>. If not, the SpringController should return a <tt>400 bad request http error code</tt>.</li>
				<li>Test that if the ClientService can correctly infer the SLOTNUM from the TOKENIND, as per <k>F8</k></li>
				<li>Test if the service correctly instruct the trolley on where to go (e.g. sends the moveToPark(SLOTNUM) to pickup a car from the correct parking slot and then the <k><k>moveToInOutdoor(outdoor)</k></k> to move it to the OUTDOOR area) and that the trolley actually sends the right commands to the BasicRobot after obtaining the path from the PlannerUtil, by checking the robot position on the map at the end of each trip, as per <k>F9</k></li>
				<li>Test the correct behaviour of the stop/resume mechanism for the trolley (e.g. test if the stopped trolley queues requests instead of executing them, test if the resumed trolley switches to the right states, etc.)</li>
			</ul>
				And here a description of the unit tests of the Sonar:
				<ul>
					<li>Test that the SonarController has the ability to request the state of the sonar</li>
					<li>Test that if the Sonar intercepts a car (the mock sets <tt>engaged=true</tt>), the SonarController successfully receives this information</li>
				</ul>
			
			<h2>Sprint Summary</h2>
			
			The coming figure represents the final outline resulting from the Sprint2. The dashed lines that group components together gives a glance of the physical deployment organization<br> 			<div>
				<td style="width:50%">
					<center><img id="Final outline" src="./img/FullSprint2Outline.png" width="70%"></center>
				</td>
			</div>
			<hr>
			<div class="remark">
						<center><k>This sprint is considered done, even though the GUI goals set in the "could have" section of the <a href="#sprint2">sprint backlog</a> are not met and therefore delegated in the third Sprint</k></center><br> 
			</div>
			
			<h3>Summary table</h3>
				<table class="sprint" id="summary">
						<thead>
							<tr>
								<th>Final Sprint Architecture</th>
								<th>Executable Model</th>
								<th>Tests</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>
									<center><a href="./img/FullSprint2Outline.png">FullSprint2Outline.png</center>
								</td>
								<td>
									<center><a target="code" href="../src/parkingArea.qak">parkingArea.qak</a></center>
								</td>
								<td>
								<center>
									<a target="code" href="../test/it/unibo/sembrava_qualcuno/sprint2/test/Sprint2ParkingAreaTests.kt">Sprint2ParkingAreaTests.kt</a><br>
									<a target="code" href="../test/it/unibo/sembrava_qualcuno/sprint2/test/Sprint2TrolleyTests.kt">Sprint2TrolleyTests.kt</a><br>
									<a target="code" href="../test/it/unibo/sembrava_qualcuno/sprint2/test/SonarTests.kt">SonarTests.kt</a>
								</center>
								</td>
							</tr>
						</tbody>
					</table>
				<hr>
		</div>
		<div class="footer">
			<center>			
				<table style="background-color:rgba(30, 22, 255, 0.9); width:60%;text-align:center;color:white">	
					<tr>
						<td colspan="2">By</td>
					</tr>
					<tr>
						<td style="width:50%">
							<img src="./img/bongiovanni_luca.jpg" style="width:50%"> <br/>
							Luca Bongiovanni <br/>
							email: luca.bongiovanni@studio.unibo.it
						</td>
						<td style="width:50%">
							<img src="./img/fototessera gmdc.jpg"  style="width:50%"><br/>
							Gian Marco De Cola <br/>		 
							email: gianmarco.decola@studio.unibo.it			 
						</td>
					</tr>
					<tr>
						<td colspan="2">
							<b>PROJECT REPO</b>: <a style="color: white;" href="https://github.com/sembrava-qualcuno/issLab21/tree/master/it.sembrava_qualcuno.unibo.tf21Start">
							https://github.com/sembrava-qualcuno/issLab21/tree/master/it.sembrava_qualcuno.unibo.tf21Start</a>
						</td>
					</tr>
				</table>
			</center>
		</div>
	</body>
</html>
